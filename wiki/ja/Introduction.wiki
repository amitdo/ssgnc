#summary 大規模 N-gram 検索システム
#labels Phase-Requirements,Phase-Design,Featured

= はじめに =

SSGNC（Search System for Giga-scale N-gram Corpus）は大規模 N-gram コーパスを対象とする検索システムであり，日英 Google N-gram コーパスに適用できます．

== 概要 ==

SSGNC では，あらかじめ N-gram コーパスから検索用のデータを構築しておくことにより，以下に示す 4 種類のクエリによる検索を実現します．

 * クエリの種類
  * *Unordered*: トークンの出現順序を考慮しない AND 検索
   * 「りんご」と「みかん」が出現する N-gram を検索します．
  * *Ordered*: トークンの出現順序を考慮する AND 検索
   * 「りんご」の後に「みかん」が出現する N-gram を検索します．
  * *Phrase*: フレーズ検索
   * 「りんご」に続いて「みかん」が出現する N-gram を検索します．
  * *Fixed*: 固定長検索
   * 「りんご みかん」を検索します．

検索用のコマンドおよび CGI プログラムを同梱しているため，コンソールやブラウザから簡単に検索機能を試すことができます．また，検索機能は C++ のライブラリとして提供されるため，任意のアプリケーションに組み込むことも可能です．

----

== 動作環境 ==

Linux での利用を想定しており，動作確認は 32-bit 版と 64-bit 版の Ubuntu でおこなっています．0.4.0 以降の SSGNC は 32-bit 環境と 64-bit 環境の両方で利用可能ですが，0.4.0 より前の SSGNC は 64-bit 環境でのみ利用可能です．

注意：検索用に構築するデータのフォーマットが異なるため，0.4.0 より前の SSGNC で構築したデータは 0.4.0 以降の SSNGC では利用できません．再構築が必要となります．

----

== インストール ==

SSGNC のビルトには，以下のツールが必要になります．

 * g++
 * make

後は，一般的なインストール方法で問題ありません．

{{{
 ./configure
 make
 make check
 make install
}}}

注意：0.4.0 より前の SSGNC では，Boost C++ ライブラリおよび dawgdic が必要です．

----

= 使い方 =

== 検索用データの構築 ==

Google N-gram コーパスと同様の構成（Ngms/Ngm-KKKK）を持つディレクトリを入力として，検索用のデータを構築します．

 * Google N-gram コーパスの構成
  * http://www.gsk.or.jp/catalog/GSK2007-C/GSK2007C_README.utf8.txt

検索用のデータを構築するコマンドは ssgnc-build.sh です．

{{{
$ ssgnc-build.sh DATA_DIR INDEX_DIR [TEMP_DIR] [CHECKER]
}}}

 * DATA_DIR: 入力ディレクトリ
  * DATA_DIR/Ngms/Ngm-KKKK を入力として検索用のデータを構築します．
  * gzip もしくは xz により圧縮されていれば，自動的に伸長します．
 * INDEX_DIR: 出力ディレクトリ
  * 構築された検索用のデータが INDEX_DIR/vocab.dic, INDEX_DIR/ngms.idx, INDEX_DIR/Ngms-KKKK.db という名前で保存されます．
 * TEMP_DIR: 一時ディレクトリ
  * 構築の途中で作成される一時ファイルの格納場所になります．
  * 省略された場合，INDEX_DIR を使用します．
 * CHECKER: 動作確認オプション
  * 時間計測およびデバッグ用のオプションです．

検索用のデータは，圧縮していない状態の入力と同程度のサイズになります．一時ファイルを格納する領域も必要になるため，入力のサイズに対して 2 倍くらいの空き領域を確保してから構築するようにしてください．

{{{
$ ssgnc-build.sh
Usage: DATA_DIR INDEX_DIR [TEMP_DIR] [CHECKER]

DATA_DIR: DATA_DIR/Ngms/Ngm-KKKK [.gz, .xz]
INDEX_DIR: INDEX_DIR/vocab.dic, ngms.idx, Ngm-KKKK.db
TEMP_DIR: TEMP_DIR/Ngm-KKKK.bin, Ngm-KKKK.part, Ngms.idx
CHECKER: time, valgrind
  time: time -f 'real %E, user %U, sys %S'
  valgrind: valgrind --leak-check=full
}}}

----

== 検索コマンド ==

N-gram を検索するコマンドは ssgnc-search です．

{{{
$ ssgnc-search [OPTION]... INDEX_DIR [FILE]...
}}}

 * OPTION: 検索オプション
  * 引数なしで ssgnc-search を実行することにより，指定可能なオプションの一覧が表示されます．
 * INDEX_DIR: 検索用データの格納場所
  * 検索用のデータとして INDEX_DIR/vocab.dic, INDEX_DIR/ngms.idx, INDEX_DIR/Ngms-KKKK.db を参照します．
 * FILE: クエリファイル
  * 各行をクエリとして読み込んで検索します．
  * 省略された場合，標準入力からクエリを読み込みます．

{{{
$ ssgnc-search
Usage: ssgnc-search [OPTION]... INDEX_DIR [FILE]...

Options:
  --ssgnc-min-freq=[1-999000000000000000]
  --ssgnc-num-tokens=[0-30][-][0-30]
  --ssgnc-min-num-tokens=[0-30]
  --ssgnc-max-num-tokens=[0-30]
  --ssgnc-max-num-results=[0-1099511627775]
  --ssgnc-io-limit=[0-1099511627775]
  --ssgnc-order=[UNORDERED, ORDERED, PHRASE, FIXED]
}}}

----

== CGI プログラム ==

SSGNC のアーカイブを展開してできるディレクトリ ssgnc-x.y.z/cgi の中にある ssgnc-cgi というコマンドが検索用の CGI プログラムです．

初期状態では，検索用データの格納場所が /usr/share/ssgnc になっています．必要に応じて，ssgnc-x.y.z/cgi/ssgnc-cgi.cc の 9 行目を編集してください．

{{{
#define SSGNC_CGI_INDEX_DIR "/usr/share/ssgnc"
}}}

また，極端に高い負荷をかけないように，取得する検索結果の数などを制限しています．必要に応じて，ssgnc-x.y.z/cgi/ssgnc-cgi.cc の 38-40 行目（デフォルト設定）および 46 行目（I/O 上限）前後を編集してください．

{{{
static const Int64 DEFAULT_MIN_FREQ = 1LL;
static const Int64 DEFAULT_MAX_NUM_RESULTS = 100LL;
static const Int64 DEFAULT_IO_LIMIT = 256LL << 10;
}}}

{{{
static const Int64 MAX_IO_LIMIT = 1LL << 20;
}}}

後は，make によりコマンドを再ビルドし，ssgnc-cgi の名前を変更して CGI プログラム用のディレクトリ（Ubuntu 10.4 + Apache2 の初期設定では /usr/lib/cgi-bin/）にコピーすれば準備完了です．ブラウザから動作の確認をおこなってください．
